<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduSense Pro | Instructor Studio</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --sidebar-bg: #0F172A;
            --main-bg: #F8FAFC;
            --text-dark: #1E293B;
            --brand-blue: #2563EB;
            --brand-green: #16A34A;
            --brand-red: #DC2626;
        }

        body {
            font-family: 'Segoe UI', 'Inter', sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background-color: var(--main-bg);
            color: var(--text-dark);
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            color: white;
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }

        .brand {
            font-size: 24px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 40px;
        }

        .control-panel h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: #94A3B8;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-start {
            background-color: var(--brand-green);
            color: white;
        }
        .btn-start:hover { background-color: #15803d; }

        .btn-stop {
            background-color: var(--brand-red);
            color: white;
            display: none; /* BaÅŸlangÄ±Ã§ta gizli */
        }
        .btn-stop:hover { background-color: #b91c1c; }

        .status-badge {
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            margin-top: 20px;
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* GRID LAYOUT */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Video geniÅŸ, Panel dar */
            gap: 20px;
            height: 100%;
        }

        /* Video Card */
        .video-card {
            background: white;
            border-radius: 16px;
            padding: 10px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: 1px solid #E2E8F0;
            position: relative;
            height: 480px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
            transform: scaleX(-1); /* Ayna efekti */
        }

        /* Placeholder (Kamera kapalÄ±yken) */
        .video-placeholder {
            position: absolute;
            color: white;
            text-align: center;
        }

        /* Overlay (Yapay Zeka SonuÃ§larÄ±) */
        .ai-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }

        .badge {
            background: rgba(255,255,255,0.95);
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 800;
            color: #333;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            font-size: 18px;
        }

        .suggestion-box {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.9);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            font-size: 16px;
            backdrop-filter: blur(4px);
            border-left: 5px solid var(--brand-blue);
        }

        /* Stats Panel (SaÄŸ Taraf) */
        .stats-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .metric-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #E2E8F0;
        }

        .metric-value {
            font-size: 42px;
            font-weight: 900;
            color: var(--text-dark);
            margin: 10px 0;
        }

        .metric-label {
            font-size: 14px;
            color: #64748B;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* CHART AREA */
        .chart-container {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: 1px solid #E2E8F0;
            height: 300px;
            margin-top: 20px;
        }

        /* REPORT SCREEN (Gizli) */
        .report-screen {
            display: none;
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border: 1px solid #E2E8F0;
            height: 100%;
            overflow-y: auto;
        }

        .report-grid {
            display: grid;
            grid-template-columns: 1fr; /* Tek kolon (GeniÅŸ grafikler iÃ§in) */
            gap: 30px;
            margin-top: 30px;
        }

        /* Renkler */
        .color-Happy { color: #16A34A; }
        .color-Anger { color: #DC2626; }
        .color-Neutral { color: #64748B; }
        .color-Fear { color: #7C3AED; }
        .color-Sad { color: #2563EB; }
        .color-Disgust { color: #059669; }
        .color-Surprise { color: #0891B2; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div>
            <div class="brand">
                <i class="fas fa-graduation-cap"></i> EduSense Pro
            </div>
            
            <div class="control-panel">
                <h3>KONTROL PANELÄ°</h3>
                <button id="btnStart" class="btn btn-start" onclick="startSystem()">
                    <i class="fas fa-play"></i> Analizi BaÅŸlat
                </button>
                <button id="btnStop" class="btn btn-stop" onclick="stopSystem()">
                    <i class="fas fa-stop"></i> Analizi SonlandÄ±r
                </button>
            </div>

            <div class="status-badge" id="statusBadge">
                <i class="fas fa-circle" style="color: #94A3B8; font-size: 10px;"></i> Sistem Beklemede
            </div>
        </div>
        
        <div style="font-size: 12px; color: #64748B; text-align: center;">
            v2.1 Cloud Edition
        </div>
    </div>

    <div class="main-content">
        
        <div id="dashboardView" class="dashboard-grid">
            
            <div class="left-col">
                <div class="video-card">
                    <div id="videoPlaceholder" class="video-placeholder">
                        <i class="fas fa-video-slash" style="font-size: 40px; margin-bottom: 10px;"></i><br>
                        Kamera KapalÄ±
                    </div>
                    <video id="videoElement" autoplay playsinline style="display: none;"></video>
                    
                    <div id="aiOverlay" class="ai-overlay" style="display: none;">
                        <div class="badge" id="emotionBadge">...</div>
                    </div>
                    <div id="suggestionBox" class="suggestion-box" style="display: none;">
                        Analiz BaÅŸlatÄ±lÄ±yor...
                    </div>
                </div>

                <div class="chart-container" style="height: 200px;">
                    <canvas id="liveChart"></canvas>
                </div>
            </div>

            <div class="stats-panel">
                <div class="metric-card">
                    <div class="metric-label">AnlÄ±k SÄ±nÄ±f Modu</div>
                    <div id="dominantMetric" class="metric-value">--</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-label">Ders SÃ¼resi</div>
                    <div id="timer" class="metric-value" style="font-size: 32px;">00:00</div>
                </div>

                <div class="metric-card" style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                    <i class="fas fa-robot" style="font-size: 40px; color: var(--brand-blue); margin-bottom: 20px;"></i>
                    <p style="color: #64748B;">Pedagojik asistan aktif ve sÄ±nÄ±fÄ± izliyor.</p>
                </div>
            </div>
        </div>

        <div id="reportView" class="report-screen">
            <h1 style="color: var(--text-dark); margin-bottom: 5px;">ðŸ“‹ Ders Sonu Raporu</h1>
            <p style="color: #64748B;">Oturum baÅŸarÄ±yla tamamlandÄ±. Ä°ÅŸte dersin detaylÄ± duygu analizi.</p>
            <hr style="border: 0; border-top: 1px solid #E2E8F0; margin: 20px 0;">

            <div class="chart-container" style="height: 400px; position: relative;">
                <canvas id="timelineChart"></canvas>
            </div>

            <div class="report-grid" style="grid-template-columns: 1fr 1fr;">
                <div class="chart-container" style="height: 350px;">
                    <canvas id="reportBarChart"></canvas>
                </div>

                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <div class="metric-card" style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                        <div class="metric-label">Hakim Duygu</div>
                        <div id="reportDominant" class="metric-value" style="color: var(--brand-blue);">--</div>
                    </div>
                    <div class="metric-card" style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                        <div class="metric-label">Toplam SÃ¼re</div>
                        <div id="reportTime" class="metric-value">--</div>
                    </div>
                </div>
            </div>

            <br>
            <button class="btn btn-start" onclick="location.reload()" style="width: 250px; margin: 20px auto;">
                <i class="fas fa-redo"></i> Yeni Ders BaÅŸlat
            </button>
        </div>

    </div>

    <script>
        const video = document.getElementById('videoElement');
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        
        // UI ElemanlarÄ±
        const btnStart = document.getElementById('btnStart');
        const btnStop = document.getElementById('btnStop');
        const videoPlaceholder = document.getElementById('videoPlaceholder');
        const aiOverlay = document.getElementById('aiOverlay');
        const suggestionBox = document.getElementById('suggestionBox');
        const emotionBadge = document.getElementById('emotionBadge');
        const dominantMetric = document.getElementById('dominantMetric');
        const timerLabel = document.getElementById('timer');
        const statusBadge = document.getElementById('statusBadge');
        
        // Ekranlar
        const dashboardView = document.getElementById('dashboardView');
        const reportView = document.getElementById('reportView');

        let isAnalyzing = false;
        let intervalId = null;
        let timerId = null;
        let seconds = 0;
        let emotionHistory = []; // {time: '12:00:01', emotion: 'Happy'}

        // Chart.js Kurulumu (CanlÄ± Grafik)
        const liveCtx = document.getElementById('liveChart').getContext('2d');
        let liveChart = new Chart(liveCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Trend',
                    data: [],
                    borderColor: '#2563EB',
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(37, 99, 235, 0.1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { display: false } }
            }
        });

        // API Adresi
        const API_URL = "http://127.0.0.1:8000/predict";

        // Renk HaritasÄ± (Grafikler iÃ§in)
        const EMOTION_COLORS = {
            'KÄ±zgÄ±n': '#DC2626', // KÄ±rmÄ±zÄ±
            'KÃ¼Ã§Ã¼mseme': '#EA580C', // Turuncu
            'Tiksinti': '#059669', // YeÅŸil
            'Korku': '#7C3AED', // Mor
            'Mutlu': '#16A34A', // AÃ§Ä±k YeÅŸil
            'NÃ¶tr': '#64748B', // Gri
            'ÃœzgÃ¼n': '#2563EB', // Mavi
            'ÅžaÅŸkÄ±n': '#0891B2' // Cyan
        };

        const EMOTION_ORDER = ['KÄ±zgÄ±n', 'KÃ¼Ã§Ã¼mseme', 'Tiksinti', 'Korku', 'Mutlu', 'NÃ¶tr', 'ÃœzgÃ¼n', 'ÅžaÅŸkÄ±n'];

        async function startSystem() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                
                video.style.display = 'block';
                videoPlaceholder.style.display = 'none';
                aiOverlay.style.display = 'flex';
                suggestionBox.style.display = 'block';
                btnStart.style.display = 'none';
                btnStop.style.display = 'flex';
                statusBadge.innerHTML = '<i class="fas fa-circle" style="color: #16A34A; font-size: 10px;"></i> Analiz Aktif';
                
                isAnalyzing = true;
                seconds = 0;
                emotionHistory = []; 
                
                timerId = setInterval(() => {
                    seconds++;
                    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const secs = (seconds % 60).toString().padStart(2, '0');
                    timerLabel.innerText = `${mins}:${secs}`;
                }, 1000);

                intervalId = setInterval(sendFrameToAI, 500); 

            } catch (err) {
                alert("Kamera izni verilmedi!");
            }
        }

        function stopSystem() {
            isAnalyzing = false;
            clearInterval(intervalId);
            clearInterval(timerId);
            
            const stream = video.srcObject;
            if (stream) stream.getTracks().forEach(track => track.stop());

            dashboardView.style.display = 'none';
            reportView.style.display = 'block';
            
            generateReport();
        }

        async function sendFrameToAI() {
            if (!isAnalyzing) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);

            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('file', blob, 'image.jpg');

                try {
                    const response = await fetch(API_URL, { method: 'POST', body: formData });
                    const data = await response.json();
                    updateUI(data);
                } catch (error) {
                    console.error("API HatasÄ±:", error);
                }
            }, 'image/jpeg');
        }

        function updateUI(data) {
            emotionBadge.innerText = data.emotion_tr;
            suggestionBox.innerText = data.suggestion;
            dominantMetric.innerText = data.emotion_tr;
            
            const en_to_tr = {
                'Anger': 'KÄ±zgÄ±n', 'Happy': 'Mutlu', 'Neutral': 'NÃ¶tr',
                'Surprise': 'ÅžaÅŸkÄ±n', 'Disgust': 'Tiksinti', 'Fear': 'Korku', 'Sad': 'ÃœzgÃ¼n', 'Contempt': 'KÃ¼Ã§Ã¼mseme'
            };
            const tr_emotion = en_to_tr[data.emotion] || 'NÃ¶tr';
            const color = EMOTION_COLORS[tr_emotion] || '#333';
            
            dominantMetric.style.color = color;
            emotionBadge.style.color = color;
            suggestionBox.style.borderLeftColor = color;

            // Veriyi kaydet (Zaman damgasÄ±yla)
            const now = new Date();
            emotionHistory.push({
                x: now, // Zaman
                y: tr_emotion, // Duygu (Y ekseni iÃ§in)
                emotion: tr_emotion // Renk iÃ§in
            });

            // CanlÄ± Grafik GÃ¼ncelleme
            if (liveChart.data.labels.length > 30) {
                liveChart.data.labels.shift();
                liveChart.data.datasets[0].data.shift();
            }
            liveChart.data.labels.push("");
            // Basit bir sayÄ±sal deÄŸer atayalÄ±m canlÄ± grafik akÄ±ÅŸÄ± iÃ§in
            let val = 0;
            if (['Mutlu', 'ÅžaÅŸkÄ±n'].includes(tr_emotion)) val = 1;
            else if (['NÃ¶tr'].includes(tr_emotion)) val = 0.5;
            
            liveChart.data.datasets[0].data.push(val);
            liveChart.update();
        }

        function generateReport() {
            // Ä°statistikleri Hesapla
            const counts = {};
            emotionHistory.forEach(d => { counts[d.emotion] = (counts[d.emotion] || 0) + 1; });
            
            const labels = Object.keys(counts);
            const data = Object.values(counts);
            
            // BaskÄ±n Duygu
            const sorted = Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
            document.getElementById('reportDominant').innerText = sorted[0] || "Veri Yok";
            document.getElementById('reportTime').innerText = document.getElementById('timer').innerText;

            // --- 1. ZAMAN Ã‡Ä°ZELGESÄ° (TIMELINE SCATTER PLOT) ---
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            
            // Veriyi Chart.js formatÄ±na Ã§evir
            // DuygularÄ± Y ekseninde sabitlemek iÃ§in bir harita kullanalÄ±m
            // Y ekseni: KÄ±zgÄ±n, KÃ¼Ã§Ã¼mseme... diye gidecek.
            
            const scatterData = emotionHistory.map(d => ({
                x: d.x,
                y: d.emotion
            }));

            new Chart(timelineCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Duygu AkÄ±ÅŸÄ±',
                        data: scatterData,
                        backgroundColor: (ctx) => {
                            const val = ctx.raw?.y;
                            return EMOTION_COLORS[val] || '#333';
                        },
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'Ders SÃ¼resince Duygu DeÄŸiÅŸimi (Timeline)', font: {size: 16} },
                        legend: { display: false } // Renkler zaten belli
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } },
                            title: { display: true, text: 'Ders SÃ¼resi' }
                        },
                        y: {
                            type: 'category',
                            labels: EMOTION_ORDER, // Sabit sÄ±ra
                            title: { display: true, text: 'Duygu' },
                            grid: { color: '#E2E8F0' }
                        }
                    }
                }
            });

            // --- 2. HÄ°STOGRAM (BAR CHART) ---
            const barCtx = document.getElementById('reportBarChart').getContext('2d');
            // Renk dizisi oluÅŸtur
            const barColors = labels.map(l => EMOTION_COLORS[l] || '#333');

            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tespit SayÄ±sÄ±',
                        data: data,
                        backgroundColor: barColors,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        title: { display: true, text: 'Ders DÃ¶nemindeki Duygu DaÄŸÄ±lÄ±mÄ± (Histogram)', font: {size: 14} }
                    },
                    scales: {
                        y: { beginAtZero: true, title: {display: true, text: 'Frekans'} }
                    }
                }
            });
        }
    </script>
</body>
</html>